# RKS-RKL 网络功能测试文档

## 概述

本文档提供了 RKS-RKL 集中式网络架构的完整测试指南，包括所有必要的命令和预期结果。

## 环境要求

- Linux 系统 (Ubuntu/Debian/CentOS)
- Docker
- Rust 工具链
- sudo 权限
- 网络管理权限

## 快速测试 (推荐)

### 一键运行完整测试

```bash
# 进入项目目录
cd /path/to/rk8s-zh

# 给脚本执行权限
chmod +x project/rkl/test-network.sh

# 设置主机IP (替换为你的实际IP)
export HOST_IP="192.168.3.20"

# 运行完整测试
./project/rkl/test-network.sh all
```

**预期结果：**
```
=== RKS-RKL 网络功能集成测试 ===
主机IP: 192.168.3.20
RKS端口: 50051
etcd端口: 2379
节点ID: test-node-your-hostname

✅ 依赖检查完成
✅ etcd配置完成
✅ RKS配置准备完成
✅ RKL模块测试完成
✅ RKL配置准备完成
✅ RKS启动完成
✅ RKL启动完成
✅ 网络配置验证完成
✅ 日志检查完成

🎉 测试完成！
```

## 分步测试 (详细)

如果快速测试失败，可以分步执行来定位问题：

### 步骤 1: 环境设置

```bash
# 设置环境
./project/rkl/test-network.sh setup
```

**预期结果：**
- etcd 容器启动成功
- 网络配置写入 etcd
- RKS 和 RKL 配置文件生成

**验证命令：**
```bash
# 检查 etcd 状态
docker ps | grep etcd

# 检查网络配置
docker exec etcd etcdctl --endpoints=http://localhost:2379 get /coreos.com/network/config
```

**预期输出：**
```json
{"Network":"10.1.0.0/16","SubnetMin":"10.1.1.0","SubnetMax":"10.1.254.0","SubnetLen":24,"EnableIPv4":true,"EnableIPv6":false,"Backend":{"Type":"hostgw"}}
```

### 步骤 2: RKL 模块测试

```bash
# 运行 RKL 单元测试
./project/rkl/test-network.sh test
```

**预期结果：**
```
编译RKL...
   Compiling rkl v0.1.0
    Finished release [optimized] target(s)

运行网络模块单元测试...
test network::config::tests::test_validate_network_config ... ok
test network::route::tests::test_route_equal ... ok  
test network::subnet::tests::test_parse_subnet_key ... ok
test network::subnet::tests::test_write_subnet_file ... ok
test network::receiver::tests::test_network_receiver_builder ... ok

运行集成测试...
test test_network_config_parsing ... ok
test test_network_receiver_builder ... ok
test test_full_network_config_message ... ok

✅ RKL模块测试完成
```

### 步骤 3: 启动服务

```bash
# 启动 RKS 和 RKL 服务
./project/rkl/test-network.sh start
```

**预期结果：**
```
启动RKS服务...
等待RKS启动...
RKS已启动 (PID: 12345)
✅ RKS启动完成

启动RKL服务...
RKL已启动 (PID: 12346)
✅ RKL启动完成
```

**验证服务状态：**
```bash
# 检查端口
netstat -tlnp | grep :50051

# 检查进程
ps aux | grep -E "(rks|rkl)" | grep -v grep
```

### 步骤 4: 验证网络配置

```bash
# 验证网络功能
./project/rkl/test-network.sh verify
```

**预期结果：**

#### 4.1 subnet.env 文件生成
```bash
cat /tmp/rkl-test/subnet.env
```
**预期输出：**
```
RKL_NETWORK=10.1.0.0/16
RKL_SUBNET=10.1.1.0/24
RKL_MTU=1500
RKL_IPMASQ=true
```

#### 4.2 系统路由添加
```bash
ip route show | grep "10.1"
```
**预期输出：**
```
10.1.2.0/24 via 192.168.3.21 dev eth0 metric 100
10.1.3.0/24 via 192.168.3.22 dev eth0 metric 100
```

#### 4.3 etcd 中的 lease 信息
```bash
docker exec etcd etcdctl --endpoints=http://localhost:2379 get --prefix /coreos.com/network/subnets/
```
**预期输出：**
```
/coreos.com/network/subnets/10.1.1.0-24
{"PublicIP":"192.168.3.20","BackendType":"hostgw"}
```

## 手动测试命令

如果脚本不可用，可以手动执行以下命令：

### 1. 启动 etcd

```bash
# 启动 etcd 容器
docker run -d --name etcd --network host \
    quay.io/coreos/etcd:v3.5.9 \
    etcd \
    --listen-client-urls=http://0.0.0.0:2379 \
    --advertise-client-urls=http://192.168.3.20:2379 \
    --listen-peer-urls=http://0.0.0.0:2380 \
    --initial-advertise-peer-urls=http://192.168.3.20:2380 \
    --initial-cluster=default=http://192.168.3.20:2380 \
    --name=default \
    --data-dir=/etcd-data

# 配置网络参数
docker exec etcd etcdctl --endpoints=http://localhost:2379 put /coreos.com/network/config '{
    "Network":"10.1.0.0/16",
    "SubnetMin":"10.1.1.0",
    "SubnetMax":"10.1.254.0",
    "SubnetLen":24,
    "EnableIPv4":true,
    "EnableIPv6":false,
    "Backend":{"Type":"hostgw"}
}'
```

### 2. 创建 RKS 配置

```bash
cat > /tmp/rks-config.yaml << EOF
addr: "192.168.3.20:50051"
etcd_endpoints: ["http://192.168.3.20:2379"]
data_dir: "/tmp/rks-data"
node_name: "rks-test"
network:
  enable: true
  backend: "hostgw"
EOF
```

### 3. 启动 RKS

```bash
cd project/rks
export RUST_LOG=rks=info,rks::network=debug
cargo run --release -- start --config /tmp/rks-config.yaml
```

### 4. 创建 RKL 配置

```bash
sudo mkdir -p /tmp/rkl-test /etc/cni/net.d

cat > /tmp/rkl-test/config.toml << EOF
[network]
subnet_file_path = "/tmp/rkl-test/subnet.env"
rks_endpoint = "192.168.3.20:50051"
node_id = "test-node-manual"
link_index = 1
backend_type = "hostgw"
EOF
```

### 5. 启动 RKL

```bash
cd project/rkl
export RUST_LOG=rkl=info,rkl::network=debug
sudo -E env "PATH=$PATH" cargo run --release -- daemon --config /tmp/rkl-test/config.toml
```

### 6. 测试 kubectl 功能 (可选)

```bash
# 创建示例 pod 配置
cat > /tmp/test-pod.yaml << EOF
apiVersion: v1
kind: Pod
metadata:
  name: test-pod
spec:
  containers:
  - name: test-container
    image: nginx:latest
    ports:
    - containerPort: 80
EOF

# 使用 rkl_cli 创建 pod
cd project/rks  
cargo run --bin rkl_cli -- --server http://192.168.3.20:50051 create /tmp/test-pod.yaml

# 验证容器
docker ps | grep test

# 删除 pod
cargo run --bin rkl_cli -- --server http://192.168.3.20:50051 delete test-pod
```

## 故障排除

### 常见问题

#### 1. etcd 启动失败
```bash
# 检查 etcd 日志
docker logs etcd

# 检查端口占用
netstat -tlnp | grep 2379

# 重新启动
docker stop etcd && docker rm etcd
# 然后重新运行启动命令
```

#### 2. RKS 连接 etcd 失败
```bash
# 检查 etcd 连通性
curl http://192.168.3.20:2379/health

# 检查 RKS 日志
tail -f /tmp/rks.log

# 检查防火墙
sudo ufw status
sudo iptables -L
```

#### 3. RKL 连接 RKS 失败
```bash
# 检查 RKS 端口
nc -z 192.168.3.20 50051

# 检查 RKL 日志
sudo tail -f /tmp/rkl.log

# 检查 QUIC 连接
grep -i quic /tmp/rkl.log
```

#### 4. 路由添加失败
```bash
# 检查权限
sudo -v

# 手动测试路由添加
sudo ip route add 10.1.99.0/24 via 192.168.3.1 dev eth0
sudo ip route del 10.1.99.0/24

# 检查网络接口
ip link show
```

### 日志位置

- **RKS 日志**: `/tmp/rks.log`
- **RKL 日志**: `/tmp/rkl.log`  
- **etcd 日志**: `docker logs etcd`
- **系统路由**: `ip route show`
- **etcd 数据**: `docker exec etcd etcdctl get --prefix /`

## 清理环境

测试完成后清理环境：

```bash
# 使用脚本清理
./project/rkl/test-network.sh cleanup

# 或手动清理
sudo pkill -f "cargo run.*rkl"
pkill -f "cargo run.*rks"
docker stop etcd && docker rm etcd
sudo rm -rf /tmp/rkl-test /tmp/rks-data
rm -f /tmp/rks.log /tmp/rkl.log /tmp/*config*
```

## 成功标准

测试成功的标志：

1. ✅ etcd 正常启动并包含网络配置
2. ✅ RKS 成功连接 etcd 并启动监听
3. ✅ RKL 成功连接 RKS 并注册节点
4. ✅ subnet.env 文件正确生成
5. ✅ 系统路由正确添加
6. ✅ etcd 中存在网络 lease 信息
7. ✅ 日志显示正常的网络配置同步

完成这些验证后，说明 RKS-RKL 集中式网络架构工作正常！
